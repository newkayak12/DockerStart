# 쿠버네티스

### 5.1 쿠버네티스 설치 환경과 종류
```dockerfile
    쿠버네티스는 도커 스웜 모드 처럼 여러 대의 도커 호스트를 하나의 클러스터로 만들어 준다는 점은 같지만 세부적인 기능을 더욱 폭 넓게 제공하고 있다. 
    (miniKube로 가상화해볼 수도 있다.)
    
    쿠버네티스의 사용환경은 크게 두 가지 종류로 나뉜다. 첫 번째는 AWS, GKE 등의 클라우드 플랫폼 환경이고,  두 번째는 자체적으로 보유한 
    온프레미스(on-premise) 서버 환경이다.  EKS, GKE 등의 매니지드 쿠버네티스를  사용하면 클라우드 의존성이 높아지는 반면 관리의 복잡도는 감소한다.
    반대로 자체 서버에 쿠버네티스를 설치하면 클라우드 의존도는 낮지만 관리의 복잡도가 높아진다. AWS와 같은 서버 인프라에 설치시 클라우드 의존성, 
    관리 복잡도 모두 중간 정도 수준이다.
    
    1. 자체 서버 환경에서 쿠버네티스 설치
    자체 서버 환경(on-premise)에서 쿠버네티스를 설치해 사용하기로 했다면 쿠버네티스를 포함한 모든 인프라를 직접 관리해야한다. 쿠버네이트스와 서버 인프라를
    세밀한 부분까지 설정해서 원하는 대로 커스터마이징 할 수는 있지만 모든 관리를 직접 해야 해서 운영 및 유지 보수가 어려울 수도 있다는 단점이 있다.
    자체 서버 환경에서는 kuespray, kubeadm 등의 도구를 이용해서 쿠버네티스를 설치할 수 있다. 
    
    2. 클라우드 플래폼에서 쿠버네티스 설치 
    클라우드 플랫폼에서 쿠버네티스를 사용한다면 서버 인스턴스만을 사용해서 쿠버네티스를 설치할지, 쿠버네티스 자체를 서비스로서 제공하는 매니지드 서비스를 사용
    할지 선택해야한다. 전자는 서버, 네트워크 등 인프라에 대한 관리는 AWS,GCP와 같은 클라우드 제공자에게 맡기되, 쿠버네티스의 설치 및 관리를 직접 수행해야
    한다. 후자는 AWS의 EKS(Elastic Kubernetes Service), GCP의 GKE(Google Kubernetes Engine) 등의 매니지드 서비스를 이용해서 쿠버네티스
    를 사용하는 방식인데 쿠버네티스 설치, 관리까지 클라우드 제공자가 담당하므로 쿠버네티스 관리 및 유지 보수의 비용이 줄어든다. EKS, GKE와 같은 매니지드
    서비스를 사용하면 별도로 쿠버네티스를 설치할 필요 없이 실제 서비스 환경을 구성할 수 있다는 장점이 있다. 
```

    


| 사용 가능한 쿠버네티스 설치 도구 또는 서비스 |                                             특징                                              |
|:-------------------------:|:-------------------------------------------------------------------------------------------:|
|      Docker Desktop       |  - 1개의 노드에서 쿠버네티스 설치 및 사용<br/>-간편하게 로컬에서 쿠버네티스의 기본 기능 테스트 가능<br/>- 쿠버네티스의 일부 기능이 제한될 수 있음   |
|  GKE, EKS 등의 완전 관리형 서비스   |       - 설치가 필요 없기 떄문에 가장 손쉬움 <br/>-클라우드 플랫폼에 종속적인 기능도 사용 가능 <br/>-클라우드 사용 비용 및 의존성 증가       |
|    kupespray, kubeadm     | - 온프레미스 환경에서도 쿠버네티스 설치 가능<br/>- 클라우드 인프라이서도 쿠버네티스 설치 가능<br/>-서버 인프라 및 쿠버네티스 관리가 다소 어려울 수 있음 |
|           kops            |             - 특정 클라우드 플랫폼에서 쉽게 쿠버네티스 설치 가능<br/>- 서버, 네트워크 등 각종 인프라도 자동으로 프로비저닝              |

```dockerfile
    {
        쿠버네티스는 클라우드 플랫폼에서만 사용할 수 있는 기능이 일부 포함되어 있다. 예를 들어 로컬 개발 환경이나 온프레미스 서버에서 쿠버네티스를 설치해서 
        사용할 경우 로드 밸런서(LoadBalacner) 또는 퍼시스턴트 볼륨(Persistent Volume) 등의 기능을 사용하지 못할 수도 있습니다.
        이러한 기능들은 kops(AWS) 또는 GKE를 이용해서 쿠버네티스를 사용하면 사용할 수 있습니다. 
    }
```


### 5.3 개발 용도의 쿠버네티스 설치
### 5.3.2 Minikube로 쿠버네티스 설치
```dockerfile
    Minikube는 로컬에서 가상 머신이나 도커 엔진을 통해 쿠버네티스를 사용할 수 있는 환경을 제공한다. Docker Desktop에 내장된 쿠버네티스와 마찬가지로
    쿠버네티스의 기능을 간단히 사용해 볼 수 있지만, 실제 운영환경에서는 적용하기 어렵다는 단점이 있다. 
```
### 5.4 여러 서버로 구성된 쿠버네티스 클러스터 설치
```dockerfile
    이번 절에서는 여러 개의 서버를 이용해서 쿠버네티스 클러스터를 설치하는 방법인 kubeadm, kops, GKE에 대해서 알아본다. 사용할 서버는 알아서 준비하면
    되지만, 각종 기능을 제대로 사용하려면 최소 3대 이상의 서버를 준비하는 것이 좋다. 또한 각 서버에서 아래의 항목들을 준비해야한다.
    
    1. 모든 서버 시간이 ntp를 통해서 동기화 되어 있어야한다.
    2. 모든 서버의 MAC 주소가 다른지 확인해야한다. 가상 머신을 복사해서 사용할 경우, 같은 맥 주소를 가지는 서버가 존재할 수도 있다.
    3. 모든 서버가 2GB 메모리, 2CPU이상의 충분한 자원을 가지고 있는지 확인해야한다.
    4. 모든 서버에서 메모리 스왑을 비활성화 시킨다. 메모리 스왑이 활성화되어 있으면 컨테이너의 성능이 일관되지 않을 수 있기 때문이다. 
    그래서 대부분의 쿠버네티스 설치 도구는 메모리 스왑을 허용하지 않는다.
         
```
#### 5.4.1 kubeadm으로 쿠버네티스 설치 
```dockerfile
    쿠버네티스는 일반적으로 서버 클러스터 환경에서도 쿠버네티스를 쉽게 설치할 수 있는 kubeadm이라는 관리 도구를 제공한다. minikube, kubespray와 같은 
    설치 도구도 내부적으로 kubeadm을 사용하는 등 활발히 개발되고 있는 쿠버네티스 설치 도구이다. kubeadm은 온프레미스 환경, 클라우드 인프라 환경에 상관
    없이 일반적인 리눅스 서버라면 모두 사용할 수 있다. 
    {
        AWS에서 kubeadm으로 쿠버네티스를 설치해서 로드 밸런서와 같은 클라우드 플랫폼의 기능을 사용하는 것이 불가능한 것은 아니다. kubeadm으로 클라우드
        플랫폼과 쿠버네티스를 연동하고 싶으면 클라우드 프로바이더 및 프로비저닝을 직접 설정해주면 된다.
    }
    
    1. 쿠버네티스 저장소 추가
    쿠버네티스를 설치할 모든 노드에서 아래의 명령어를 입력해서 쿠버네티스 저장소를 추가한다.
        'curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -'
        'cat <<EOF >> /etc/apit/sources.list.d/kubernetes.list deb http://apit.kubernetes.io/ kubernetes-xenial main 
        EOF'
        
    2. kubeadm 설치
    쿠버네티스를 사용하기 위해서 꼭 도커 컨테이너를 사용해야하는 것은 아니지만, 일단 컨테이너를 사용한다는 것을 전제로 하기 때문에 도커를 설치한다.
    'wget -q0- get.docker.com | sh'
    'apt-get install -y kubelet kubeadm kubectl kubernetes-cni'
    
    3. 쿠버네티스 클러스터 초기화
    마스터 노드로 사용할 호스트에서 아래의 명령어로 클러스터를 초기화한다. 
    'kubeadm init --apiserver-advertise-address 172.31.0.100  --pod-network-cidr=192.168.0.0/16'
    
    {
        1. --apiserver-advertise-address : 옵션의 인자에 다른 노드가 마스터에게 접근할 수 있는 IP 주소를 환경에 맞게 입력한다.
        2. --pod-network-cdir : 쿠버네티스에서 사용할 컨테이너의 네트워크 대역이며, 각서버의 네트워크 대역과 중복되지 않게 선택한다.
        3. 특정 버전의 쿠버네티스를 설치하려면 --kubernetes-version 1.13.5와 같이 kubeadm init 명령어에 버전 옵션을 추가한다.
    }
    'mkdir -p $HOME/.kube'
    'sudo cp -i /etc/kebernetes/admin.conf $HOME/.kube/config'
    'sudo chown $(id -u)"$(id:-g) $HOME/.kube/config'
    를 마스터 노드에서 실행한 후, 
    
    'kubeadm join [ip] --token [token]'을 워커 노드에서 실행한다.
     
    4. 컨테이너 네트워크 애드온 설치
    쿠버네티스의 컨테이너 간 통신을 위해 flannel, weabeNet 등 여러 오버레이 네트워크를 사용할 수 있지만 이번에는 마스터 노드에서 calico 네트워크 
    플러그인을  설치한다.
    
        'kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml'
    
    설치가 정상적으로 완료됐는지 확인하기 위해서 'kubectl get pods --namespace kube-system'을 입력해서 핵심 컴포넌트들의 실행 목록을 확인한다.
    
    'kubectl get nodes'로 쿠버네티스에 등록된 모든 노드를 확인할 수 있다. 또한 kubeadm으로 설치된 쿠버네티스는 각 노드에서 'kubeadm reset'으로
    삭제할 수 있다.
```
