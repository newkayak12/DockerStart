# 02. 도커 엔진

 도커 엔진에서 사용하는 기본 단위는 이미지와 컨테이너이다. 
 ```dockerfile
 2.2.1 도커 컨테이너 생성
 
    - 도커 이미지
        : 도커 이미지는 컨테이너 생성에 필요한 요소이다. iso 파일과 비슷한 개념이다. 읽기 전용으로 사용된다.
        도커에서 사용하는 이미지 이름은 기본적으로 [저장소 이름]/[이미지 이름]:[태그]로 구성된다.
        
         alicek106/ubuntu:14.04
         [저장소이름]/[이미지이름]:태그
         
         {
            저장소 이름 : 이미지가 저장된 장소 이름이 명시되지 않으면 DockerHub 공식 이미지, 생성 시 생략도 가능
            이미지 이름 : 이미지의 역할
            태그 : 버전관리, revision 관리에 사용
         }
     
     

    - 도커 컨테이너 
        : 우분투, MySQL 등의 애플리케이션으로 컨테이너를 생성하면 해당 이미지의 목적이 맞는 파일들이 있응 파일시스템과 
        격리된 시스템 자원 및 네트워크를 사용할 수 있는 독립된 공간이 생성되고, 이것이 바로 도커 컨테이너가 된다.
        대부분의 도커 컨테이너는 생성될 떄 사용된 도커 이미지의 종류에 따라 알맞는 설정과 파일을 가지고 있기 때문에 
        도커 이미지의 목적에 맞도록 사용되는 것이 일반적이다.
        
       컨테이너는 이미지를 읽기 전용으로 사용하되 이미지에서 변경된 사항만 컨테이너 계층에 저장하므로 컨테이너에서 무엇을 하든
       원래 이미지에는 영향을 주지 않는다. 또한 생성된 각 컨테이너는 각기 독립된 파일 시스템을 제공받으며 호스트와 분리돼 있으므로
       특정 컨테이너에서 변화를 주더라도 다른 컨테이너, 호스트는 이와 격리된다.
           
          
          
         `docker run -i -t ubuntu:14.04`

          {
            -i: 상호 입출력
            -t: tty를 활성화 해서 bash를 사용하도록 컨테이너를 설정
            
            docker run에서 이 둘 중 하나라도 사용하지 않으면 셸을 정상적으로 사용할 수 없다. 
          }
          
      와 같이 실행하면 ubuntu:14.04가 설치된다.
       
        root@ubuntu:/home/pi# docker run -i -t ubuntu:14.04
        Unable to find image 'ubuntu:14.04' locally
        14.04: Pulling from library/ubuntu
        d1a5a1e51f25: Pull complete 
        e5fc464c2dc9: Pull complete 
        561f253b7549: Pull complete 
        Digest: sha256:60840958b25b5947b11d7a274274dc48ab32a2f5d18527f5dae2962b64269a3a
        Status: Downloaded newer image for ubuntu:14.04
         
        root@cef48f96d5b7:/#
        
    셸의 사용자와 호스트 이름이 변경된 것을 보면 컨테이너 내부에 들어와 있다는 것을 의미한다.  이 상태를 빠져나오는 방법은 Ctrl+P, Q를 입력하거나
    'exit'을 입력하는 방법이있다. 'exit'은 bash를 종료함으로써 컨테이너를 정지시키면서 빠져나오지만 Ctrl+P, Q는 셸에서만 빠져나오기 떄문에
    컨테이너 애플리케이션을 개발하는 목적으로 많이 사용한다.
    
        'docker pull /이미지:버전/'
    
    으로 이미지를 내려 받을 수도 있으며 
    
        'docker images'
    
    로 도커 엔진에 존재하는 이미지 목록을 출력할 수도 있습니다.
    
            root@ubuntu:/home/pi# docker images
        REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
        ubuntu       14.04     7304c635fe52   5 months ago   187MB
    
    뿐만 아니라 컨테이너 생성할 때는 'run'이 아닌 'create'를 사용할 수도 있습니다.
    
    
        'docker create -i -t --name [name] [image:version]'
        
    '--name' 옵션은 컨테이너의 이름을 설정한다.  이 명령어는 'run'과는 달리 컨테이너 내부로 진입하지 않는다.
    create 명령어는 컨테이너를 생성만 할 뿐 컨테이너로 들어가지 않기 때문이다.
    
    
        'docker start [name]'
        'docker attach [name]'
        
    'start'는 컨테이너를 시작하는 명령어이고 'attach'는 컨테이너 내부로 들어가는 명령어이다.
        
        
    /////
    정리하면, run은 pull/ create/ start를 실행하고 attach가 가능하면 컨테이너 내부로 들어간다.
    create는 도커 이미지를 pull한 뒤 생성만할 뿐 start, attach는 실행하지 않는다.
    
    {
        컨테이너를 대상으로 하는 모든 명령어는 컨테이너의 이름 대신 ID를 쓸 수 있다. ID가 너무 길면 앞의 2~3글자만 
        입력해도 된다. 
    }
    /////
```    
```docker    
2.2.2 컨테이너 목록 확인
        'docker ps'
        
        CONTAINER ID   IMAGE          COMMAND       CREATED        STATUS        PORTS     NAMES
        6004350d8d73   ubuntu:14.04   "/bin/bash"   12 hours ago   Up 12 hours             blog
    
    'docker ps'는 정지되지 않은 컨테이너만 출력합니다. 정지된 컨테이너를 포함한 모든 컨테이너를 출력하려면 '-a' 옵션을 추가합니다. 
    컨테이너의 상태는 STATUS 항목에서 확인합니다.

        CONTAINER ID   IMAGE          COMMAND       CREATED        STATUS                      PORTS     NAMES
        6004350d8d73   ubuntu:14.04   "/bin/bash"   12 hours ago   Up 12 hours                           blog
        cef48f96d5b7   ubuntu:14.04   "/bin/bash"   12 hours ago   Exited (137) 12 hours ago             ecstatic_mcnulty

     {
        CONTAINER ID : 컨테이너에게 자동으로 할당되는 고유한 ID이다. docker inspect 명령어를 사용하면 전체 ID를 확인할 수 있다.
        IMAGE : 컨테이너를 생성할 때 사용된 이미지의 이름입니다. 
        COMMAND : 컨테이너가 시작될 때 실행될 명령어이다. 커맨드는 대부분의 이미지에 미리 내장되어 있기 때문에 별도로 설정할 필요는 없다.
                docker run이나 create 명령어의 맨 끜에 입력해서 컨테이너를 생성할 떄 덮어쓸 수가 있다. 예를 들어 'docker run' 명령어로 생성되는
                컨테이너에 원하는 커맨드를 넣고 싶으면 'docker run -i -t [이미지:버전] [명령어]'와 같이 실행시키면 됩니다.
        CREATED : 컨테이너가 생성되고 난 뒤 흐른 시간을 나타냅니다.
        STATUS :  컨테이너의 상태를 나타내며, 컨테너가 실행 중일 때는 UP, 종료된 상태인 Pauesd가 있다. 
        PORTS : 컨테이너가 개방한 포트와 호스트에 연결한 포트를 나열한다. (외부에 노출하도록 설정하지 않으면 아무 것도 출력되지 않는다.)
        NAMES : 컨테이너의 고유한 이름이다. 컨테이너 생성 때 --name 옵션으로 이름을 정하지 않으면 임의로 이름을 지정한다.
        --
            --format 옵션에 {{.ID}}\t{{.Status}}와 같은 Go 템플릿을 입력해서 입력하는 정보만 출력할 수 있다.
        -- 
     }
```
```dockerfile
2.2.3 컨테이너 삭제
    더 이상 사용하지 않는 컨테이너를 삭제할 때는 docker rm 명령어를 사용한다. 한 번 삭제하면 복구할 수 없다. 실행 중인 컨테이너는
    삭제할 수 없으므로 컨테이너를 정지한 뒤 삭제해야한다. 다른 방법은 rm 명령어에 '-f' 옵션을 추가하는 것이다. 'docker rm -f [컨테이너 명]'
    
        'docker conatiner prune'
    
    컨테이너가 너무 많이 일일이 삭제하기 귀찮은 경우 prune 명령어를 입력해서 모든 컨테이너를 삭제할 수 있다. 
    docker ps 명령어의 '-a' 옵션과 '-q' 옵션을 조합해 컨테이너를 삭제할 수도 있습니다. '-a'는 모든 컨테이너를
    '-q'는 ID 만 출력하는 역할을 합니다.
    
        'docker stop $(docker ps -a -q)'
        'docker rm $(docker ps -a -q)'
 ```
```dockerfile
2.2.4 컨테이너를 외부에 노출
    
    컨테이너는 가상 머신과 마찬가지로 가상 IP주소를 할당받는다. 기본적으로 도커는 컨테이너에 172.17.0.x의  IP를 순차적으로 할당한다.
    ifconfig 명령어로 컨테이너의 네트워크 인터페이스를 확인할 수 있다.
       
    eth0      Link encap:Ethernet  HWaddr 02:42:ac:11:00:02  
              inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0
              UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
              RX packets:29 errors:0 dropped:0 overruns:0 frame:0
              TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:0 
              RX bytes:2206 (2.2 KB)  TX bytes:0 (0.0 B)
    
    lo        Link encap:Local Loopback  
              inet addr:127.0.0.1  Mask:255.0.0.0
              UP LOOPBACK RUNNING  MTU:65536  Metric:1
              RX packets:0 errors:0 dropped:0 overruns:0 frame:0
              TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:1000 
              RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

    
    NAT IP인 172.17.0.2를 할당받은 eth0 인터페이스와 로컬 호스트인 lo 인터페이스가 있다. 아무런 설정을 하지 않았다면
    이 컨테이너는 외부에서 접근할 수 없으며 도커가 설치된 호스트에서만 접근할 수 있다. 

        'docker run -i -t --name [컨테이너 이름] -p [호스트IP]:[호스트 포트]:[컨테이너 포트] [이미지]:[버전]'
    
    '-p' 명령어를 추가해서 컨테이너를 만들면 아파치를 사용해서 포트를 외부에 개방할 수 있다. 
    
        'docker start [컨테이너 이름]'
        'docker attach [컨테이너 이름]'
        'docker ps'
        
        CONTAINER ID   IMAGE          COMMAND       CREATED          STATUS          PORTS                                       NAMES
        92e6b1081c85   ubuntu:14.04   "/bin/bash"   56 seconds ago   Up 42 seconds   0.0.0.0:1247->1247/tcp, :::1247->1247/tcp   blog
    
    호스트ip를 위와 같이 따로 지정할 수도 있으며, 여러 개의 포트를 외부에 개방하려면 -p 옵션을 여러 번 써서 설정한다. 

    컨테이너를 생성해 내부로 들어오면 아파치 웹 서버를 설치한다.
    
        'apt-get update'
        'apt-get install apache2 -y'
        'service apache2 start'
        
    아파치 기본 포트는 80이다. (컨테이너 포트)
```

```dockerfile
2.2.5 컨테이너 애플리케이션 구축
    대부분의 서비스는 단일 프로그램으로 동작하지 않는다. 여러 에이전트나 데이터베이스 등과 연결되어 완전한 서비스로써 동작한다.
    이런 서비스를 컨테이너화 할 때 여러 개의 애플리케이션을 한 컨테이너에 설치할 수도 있다. 그러나 컨테이너에 애플리케이션을 하나만
    동작시키면 컨테이너 간의 독립성을 보장함과 동시에 애플리케이션의 버전 관리, 소스코드 모듈화 등이 더욱 쉬워진다.
    이러한 구조는 도커 커뮤니티 뿐 아니라 도커 공식 홈페이지에서도 권장하는 구조이다. 
    {
        가독성을 위해 명령어의 길이가 길면 '\'를 이용해서 각 옵션을 구분합니다.
        -d 옵션 : -i -t 컨테이너 내부로 진입하도록 attach 가능한 상태로 설정한다면 -d는 Detached 모드로
            컨테이너를 실행합니다. Detached 모드는 컨테이너를 백그라운드에서 동작하는 애플리케이션으로써 실행하도록 설정합니다.
            -i -t 옵션을 실행하면 표준 입출력이 활성화된, 상호작요잉 가능한 셸 환경을 사용할 수 있습니다.
            -d옵션으로 rundㅡㄹ 실행하면 입출력이 없는 상태로 컨테이너를 실행합니다. 컨테이너 내부에서 프로그램이 터미널을 차지하는
            foreGround 상태로 실행되 사용자의 입력을 받지 않습니다. Detached 모드인 컨테이너는 반드시 컨테이너에서 프로그램이 실행
            돼야 하며, 포그라운드 프로그램이 실행되지 않ㅇ드면 컨테이너는 종료됩니다.
        
        -e 옵션: 컨테이너 내부의 환경변수를 설정합니다. 컨테이너화된 애플리케이션은 환경변수에서 값을 가져와 쓰는 경우가 많으므로
        자주 사용하는 옵션 중 하나입니다. mysql 컨테이너를 생성할 때 설정인 '-e' 옵션의 값을 살펴보면 mysql 컨테이너의 환경
        변수로 어떤 것이 설정됐는지 알 수 있습니다.
        
        -d 옵션이 사용된 상태에서 attach를 사용하면 컨테이너에서 실행 중인 프로그램의 로그 출력을 보게된다. 그러나 'exec' 
        명령어를 사용하면 내부 셸을 사용할 수 있습니다.
            
            'docker exec -i -t mysql /bin/bash'
        
        이와 같이 실행하면 해당 명령어에 대한 결과를 반환 받을 수 있습니다.
        
        --link : A 컨테이너에서 B 컨테이너로 접근하는 방법 중 가장 간단한 것은 NAT으로 할당받은 내부 IP를 사용하는 것이다.
        B컨테이너 IP가 172.17.0.3이라면 A 컨테이너는 이 IP를 사용해서 B에 접근할 수 있다. 그러나 도커 엔진은 컨테이너에게 내부 IP
        를 순차적으로 할당한다. 이는 컨테이너를 실행할 때 할당하는 것이므로 매번 변경된다.
        
        '--link'는 내부 IP를 알 필요 없이 항상 컨테이너에 별명으로 접근하도록 설정한다. 
        
            '--link wordpressdb:mysql'
        
        즉, 워드프레스 웹 서버 컨테이너는 wordpressdb의 IP를 몰라도 mysql이라는 호스트명으로 접근할 수 있도록 한다.
         
    }

```