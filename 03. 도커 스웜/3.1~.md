# 도커 스웜

### 3.1 도커 스웜을 사용하는 이유
```dockerfile
    지금까지 알아본 도커 사용법은 대부분 하나의 호스트를 기준으로 한다. 'docker ps' 명령어는 하나의 도커 엔진에 존재하는 컨테이너의 목록을 출력하며, 
    create, run 명령어 또한 하나의 도커 엔진에 컨테이너를 생성한다. 그러나 실제로 도커를 운영 환경에 적용하면 조금 이야기가 달라진다. 하나의 호스트
    머신에서 도커 엔진을 구동하다 CPU, 메모리 등의 자원이 부족하면 어떻게 할까?
    
    가장 많이 사용하는 방법은 여러 대의 서버를 클러스터로 만들어 자원을 병렬화하는 것이다. 그러나 여러 대의 서버를 하나의 자원 풀로 만드는 것은 쉽지 않다.
    새로운 서버나 컨테이너가 추가됐을 때 이를 발견(Service Discovery)하는 작업부터 어떤 서버에 컨테이너를 할당할 것인가에 대한 스케쥴러와 로드밸런싱
    문제 클러스터 내의 서버가 다운됐을 때 고가용성(High Availbility)을 어떻게 보장할지 등이 문제로 남아있다. 이러한 문제를 해결 할 수 있는 
    대표적인 것이 도커에서 공식적으로 제공하는 docker swarm과 swarm mode이다.
```

### 3.2 스웜 클래식과 도커 스웜모드
```dockerfile
    스웜 클래식과 스웜 모드는 여러 대의 도커 서버를 하나의 클러스터로 만드렁 컨테이너를 생성하는 여러 기능을 제공한다. 다양한 전략을 세워 컨테이너를
    특정 도커 서버에 할당할 수 있고 유동적으로 서버를 확장할 수도 있다. 그뿐만 아니라 스웜 클러스터에 등록된 서버의 컨테이너를 쉽게 관리할 수 있다.
    따라서 PaaS와 같은 용도로 도커 서버 클러스터링을 고려한다면 스웜이 적격이다.
    
    도커 스웜에는 두 가지 종류가 있다. 첫 번째는 도커 버전 1.6 이후부터 사용할 수 있는 컨테이너로서의 스웜이고 ('스웜 클래식'), 두 번째는 도커 버전 
    1.12 이후로부터 사용할 수 있는 도커 스웜 모드이다.('스웜 모드') 
    
    스웜 클래식과 스웜 모드의 가장 큰 차이점은 그 목적에 있다. 스웜 클래식은 여러 대의 도커 서버를 하나의 지점에서 사용하도록 단일 접근점을 제공한다면
    스웜 모드는 마이크로서비스 아키텍처의 컨테이너를 다루기 위한 클러스터링 기능에 초점을 맞추고 있다. 스웜 클래식은 docker run, docker ps 등
    일반적인 도커 명려어와 도커 API로 클러스터의 서버를 제어하고 관리할 수 있는 기능을 제공한다. 이에 비해 스웜 모드는 같은 컨테이너를 동시에 여러 개
    생성해 필요에 따라 유동적으로 컨테이너의 수를 조절할 수 있으며, 컨테이너로의 연결을 분산하는 로드밸런싱 기능을 자체적으로 제공합니다. 개발하는 애플리케
    이션의 특성에 따라 적절한 것을 선택해 사용하면 되지만, 스웜 모드가 서비스 확장성과 안정성 등 여러 측면에서 스웜 클래식보다 뛰어나기 때문에 일반적으로
    스웜모드를 더 많이 사용한다. 
    
    스웜 클래식과 스웜 모드의 차이점은 분산 코디네이터(Distributed Coordinator), 에이전트와 같은 클러스터 툴이 별도로 구동되느냐이다. 여러 개의
    도커 서버를 하나의 클러스터로 구성하려면 각종 정보를 저장하고 동기화하는 분산 코디네이터, 클러스터 내의 서버를 관리하고 제어하는 매니저, 각 서버를 제어
    하는 에이전트가 반드시 있어야 한다. 스웜 클래식은 분산 코디네이터, 에이전트 등이 별도로 실행돼야 하지만, 스웜 모드는 클러스터링을 위한 모든 도구가 
    도커 엔진 자체에 내장돼 있기 때문에 더욱 쉽게 서버 클러스터를 구축할 수 있다.
    
    {
        분산 코디네이터는 클러스터에 영입할 새로운 서버 발견, 클러스터의 각종 설정 저장, 데이터 동기화 등에 주로 이용된다. etcd, zookeeper, consul
        등이 대표적인 예시이며, 스웜 클래식은 대부분 분산 코디네이터를 사용할 수 있다. 스웜 모드는 분산 코디네이터를 별도로 구축하지 않아도 된다. 
    }
    
    대규모 클러스터에서 서비스를 운영하는 것을 계획하고 있다면 스웜 클래식보다는 스웜모드를 사용하는 것이 좋다. 스웜 모드는 마이크로서비스 아키텍처 애플리
    케이션을 컨테이너로 구축할 수 있도록 도와줄 뿐만 아니라, 서비스 장애에 대비한 고가용성 부하 분산을 위한 로드밸런싱 기능 또한 제공하고 있기 때문이다. 
    스웜 클래식을 사용해서 도커 클러스터를 구축하는 것이 불가능한 것은 아니지만, 스웜 모드를 사용하면 더욱 많은 기능을 손쉽게 사용할 수 있기 때문에
    가능하다면 스웜모드를 사용하는 것이 좋다. 
```

### 3.3 스웜 모드
```dockerfile
    스웜모드는 별도의 설치 과정이 필요하지 않으며, 도커 엔진 자체에 내장돼 있다. docker info 명령어를 통해 도커 엔진의 스웜 모드 클러스터 정보를 확인
    할 수 있다.
        {
            서버 클러스터링을 할 때는 반드시 각 서버의 시각을 NTP 등의 툴을 이용해서 동기화해야 한다. 서버 간의 설정된 시각이 다를 경우 
            예상치 못한 오류가 발생할 수 있다.        
        }
```
#### 3.3.1 도커 스웜 모드의 구조
```dockerfile
    스웜 모드는 매니저 노드와 워커 노드로 구성돼 있다. 워커 노드는 실제로 컨테이너가 생성되고 관리되는 도커 서버이고 매니저 노드는 워커 노드를 관리하기 위한
    도커 서버이다. 그렇지만 매니저 노드에도 컨테이너가 생성될 수 있다. 즉, 매니저 노드는 기본적으로 워커 노드의 역할을 포함하고 있다.
    매니저 노드는 1개 이상 있어야 하지만 워커 노드는 없을 수도 있다. 이는 매니저 노드가 워커 노드의 역할도 포함하고 있어 매니저 노드만으로 스웜 클러스터를
    구성할 수 있기 때문이다. 그러나 일반적으로 워커 노드와 매니저 노드를 구분해서 사용하는 것이 좋다.
    
    실제 운영환경에서 스웜모드로 도커 클러스터를 구성하려면 매니저 노드를 다중화하는 것이 좋다. 이렇게 하면 매니저의 부하를 분산하고 특정 매니저 노드가
    다운됐을 떄 정상적으로 스웜 클러스터를 유지할 수 있기 떄문이다. 그러나 매니저 수를 늘린다고 스웜 클러스터의 성능이 좋아지는 것은 아니다.
    
    스웜 모드는 매니저 노드의 절반 이상에 장애가 생겨 정상적으로 작동하지 못할 경우 장애가 생긴 매니저 노드가 복구될 때까지 클러스터 운영을 중단한다. 
    만약 매니저 노드 사이에 네트워크 파티셔닝과 같은 현상이 발생했을 경우 짝수 개의 매니저로 구상한 클러스터는 운영이 중단될 수도 있지만 홀수로 구성했
    을 경우 과반수 이상이 유지되는 쿼럼 매니저에서 운영을 계속할 수 있다. 따라서 스웜 매니저는 가능한 홀수 개로 구성하는 것이 좋다. 
```

#### 3.3.2 도커 스웜 모드 클러스터 구축
```dockerfile
    'docker swarm init'으로 매니저 역할을 할 서버에서 스웜 클러스터를 시작한다. '--advertise-addr'에는 다른 도커 서버가 매니저 노드에 
    접근하기 위한 IP주소를 입력한다.
    
        'docker swarm init --advertise-addr 192.168.0.100'
        
    출력 결과 중 docker swarm join 명령어는 새로운 워커 노드를 스웜 클래스터에 추가할 때 사용된다. --token 옵션에 사용된 토큰 값은 새로운 노드를 
    해당 스웜 클러스터에 추가하기 위한 비밀 키이다. 
    
    {
        스웜 매니저는 기본적으로 2377번 포트를 사용하며 노드 간 통신에 7946/tcp, 7946/udp 포트를, 스웜이 사용하는 네트워크인 ingress 오버레이
        네트워크게 4789/tcp, 4789/udp 포트를 사용한다. 스웜 클러스터를 구성 하기 전에 이러한 포트를 각 호스트 머신에서 열어두는 것이 필요하다.
    }
```
